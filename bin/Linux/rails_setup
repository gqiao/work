#!/bin/sh

# sudo apt-get install -y build-essential libopenssl-ruby libfcgi-dev
# sudo apt-get install -y ruby irb rubygems ruby-dev
# sudo apt-get install -y sqlite3 sqlite libsqlite3-dev

# REALLY_GEM_UPDATE_SYSTEM=1 sudo gem update --system


gem sources --remove https://rubygems.org/
gem sources --remove http://rubygems.org/
if gem sources -l | grep -q "ruby.taobao.org"; then
    echo "already added taobao sources"
else
    gem sources -a http://ruby.taobao.org/
fi
gem sources -l

GET="sudo gem install "

#  debugger debugger-pry pry-remote pry-stack_explorer pry-debugger rails sqlite3 multi_json
PKGS="rails sqlite3 passenger execjs irbtools pry pry-doc ruby-debug19 rdoc rdoc-data"
for i in ${PKGS}; do ${GET} ${i}; done

if ls | grep -q "Gemfile"; then
    echo "detected ruby project in ${PWD}"
    if cat ./Gemfile | grep -q "https://rubygems.org"; then
        echo "Change Gemfile source to ruby.taobao.org"
        cp -fr ./Gemfile /tmp/
        sed 's/https:\/\/rubygems.org/http:\/\/ruby.taobao.org/g' /tmp/Gemfile > ./Gemfile
    fi
    bundle install
    bundle update
fi


sudo rdoc-data --install

#sudo chown -R ${USER}.${USER}  /var/lib/gems
